---
- name: Fedora Setup
  hosts: localhost
  become: true
  connection: local
  gather_facts: true
  vars:
    dnf_package_list: "{{ lookup('file', 'lists/fedora/dnf.txt').splitlines() | select('match', '^[^#]') | list }}"
    flatpak_package_list: "{{ lookup('file', 'lists/fedora/flatpak.txt').splitlines() | select('match', '^[^#]') | list }}"
    cargo_package_list: "{{ lookup('file', 'lists/cargo.txt').splitlines() | select('match', '^[^#]') | list }}"
    copr_repo_list: "{{ lookup('file', 'lists/fedora/copr.txt').splitlines() | select('match', '^[^#]') | list }}"
    yum_repo_list: "{{ lookup('file', 'lists/fedora/yum-repos.txt').splitlines() | select('match', '^[^#]') | list }}"

  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        # what does this do again?
        remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"

    - name: Add yum repo files
      ansible.builtin.get_url:
        url: "{{ item }}"
        dest: /etc/yum.repos.d/
      loop: "{{ yum_repo_list }}"

    - name: Enable copr repos
      community.general.copr:
        name: "{{ item }}"
        state: enabled
      loop: "{{ copr_repo_list }}"

    - name: Install dnf packages
      ansible.builtin.dnf:
        name: "{{ dnf_package_list }}"
        state: present

    - name: Add the flathub flatpak repository remote to the user installation
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
        method: system

    - name: Install flatpak packages
      community.general.flatpak:
        name: "{{ flatpak_package_list }}"
        state: present
        method: system

    - name: Install Rustup
      ansible.builtin.shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      args:
        creates: "/home/matt/.cargo/bin/cargo"
      become_user: matt

    # cargo path should already be in .bashrc
    - name: Install cargo packages
      community.general.cargo:
        name: "{{ cargo_package_list }}"
        state: present
        executable:  "/home/matt/.cargo/bin/cargo"
        # ./bin is implicitly appended to path
        path: /home/matt/
      become_user: matt
...
